openapi: 3.0.3
info:
  title: User Accounts API
  description: API для управления пользовательскими аккаунтами
  version: 1.0.0

servers:
  - url: http://localhost:8025
    description: Локальный сервер
  - url: https://api.example.com
    description: Продакшн сервер

paths:
  /oapi/v1/accounts/login:
    post:
      summary: Вход в аккаунт
      description: Аутентификация пользователя и получение JWT токенов
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: new@example.com
                password:
                  type: string
                  example: "123"
              required:
                - username
                - password
      responses:
        '200':
          description: Успешный вход. Токены установлены в cookies
          headers:
            Set-Cookie:
              schema:
                type: string
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Login successful"
        '401':
          description: Неверные учетные данные

  /oapi/v1/accounts/user:
    get:
      summary: Получить информацию о текущем пользователе
      description: Возвращает информацию о текущем аутентифицированном пользователе
      tags:
        - User Profile
      security:
        - cookieAuth: ['profile-watch']
      responses:
        '200':
          description: Успешное получение информации
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 1
                  username:
                    type: string
                    example: "jack5"
                  email:
                    type: string
                    example: "user@example.com"
                  nickname:
                    type: string
                    example: "jack33"
        '401':
          description: Пользователь не авторизован
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Unauthorized"
        '403':
          description: Недостаточно прав (отсутствует роль profile-watch)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Forbidden"
    post:
      summary: Создать пользователя
      description: Создание нового пользователя
      tags:
        - User Management
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                Nickname:
                  type: string
                  example: ImNewPerson
                Email:
                  type: string
                  format: email
                  example: new@example.com
                Username:
                  type: string
                  example: noobie
              required:
                - Nickname
                - Email
                - Username
      responses:
        '201':
          description: Пользователь успешно создан
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 42
                  message:
                    type: string
                    example: "User created successfully"
        '400':
          description: Неверные данные или пользователь уже существует
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /oapi/v1/accounts/profile:
    get:
      summary: Посмотреть информацию о пользователе по ID
      description: Получить профиль пользователя по его ID
      tags:
        - User Profile
      parameters:
        - name: X-User-Change-ID
          in: header
          required: true
          schema:
            type: integer
            example: 3
      responses:
        '200':
          description: Успешное получение профиля
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 3
                  username:
                    type: string
                    example: "user3"
                  email:
                    type: string
                    example: "user3@example.com"
        '404':
          description: Пользователь не найден
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "User not found"

  /oapi/v1/accounts/redeem-token:
    post:
      summary: Ввести токен подтверждения
      description: Подтверждение email или других действий через токен
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                Token:
                  type: string
                  format: uuid
                  example: e84e305e-80b6-4e20-841c-6d1d1e60dc4f
              required:
                - Token
      responses:
        '200':
          description: Токен успешно подтвержден
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Token redeemed successfully"
        '400':
          description: Неверный или просроченный токен
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid or expired token"

  /oapi/v1/accounts/reset-password:
    post:
      summary: Запрос на сброс пароля
      description: Отправка запроса на сброс пароля по логину
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                Login:
                  type: string
                  example: jack5
              required:
                - Login
      responses:
        '200':
          description: Запрос на сброс пароля отправлен
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Password reset email sent"
        '404':
          description: Пользователь не найден
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "User not found"

  /oapi/v1/accounts/reset-password-confirm:
    post:
      summary: Подтверждение сброса пароля
      description: Установка нового пароля после подтверждения токеном
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                Token:
                  type: string
                  format: uuid
                  example: b666a0e9-9d27-490e-98a0-bba5845eec47
                Password:
                  type: string
                  example: "8888"
              required:
                - Token
                - Password
      responses:
        '200':
          description: Пароль успешно изменен
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Password reset successful"
        '400':
          description: Неверный токен
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid token"

  /oapi/v1/accounts/username:
    put:
      summary: Сменить username пользователя
      description: Изменение имени пользователя
      tags:
        - User Profile
      security:
        - cookieAuth: ['profile-watch', 'profile-change']
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                New-Username:
                  type: string
                  example: jack2
              required:
                - New-Username
      responses:
        '200':
          description: Username успешно изменен
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Username updated successfully"
        '400':
          description: Неверный формат username
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid username format"
        '403':
          description: Недостаточно прав
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Insufficient permissions"

  /oapi/v1/accounts/description:
    put:
      summary: Сменить описание пользователя
      description: Изменение описания профиля пользователя
      tags:
        - User Profile
      security:
        - cookieAuth: ['profile-watch', 'profile-change']
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                New-Description:
                  type: string
                  example: abcdefg
              required:
                - New-Description
      responses:
        '200':
          description: Описание успешно изменено
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Description updated successfully"
        '403':
          description: Недостаточно прав
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Insufficient permissions"

  /oapi/v1/accounts/birth-date:
    put:
      summary: Сменить дату рождения пользователя
      description: Изменение даты рождения пользователя
      tags:
        - User Profile
      security:
        - cookieAuth: ['profile-watch', 'profile-change']
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                New-Birth-Date:
                  type: string
                  format: date-time
                  example: 2024-01-15T10:30:46Z
              required:
                - New-Birth-Date
      responses:
        '200':
          description: Дата рождения успешно изменена
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Birth date updated successfully"
        '400':
          description: Неверный формат даты
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid date format"
        '403':
          description: Недостаточно прав
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Insufficient permissions"

  /oapi/v1/accounts/nickname:
    put:
      summary: Сменить nickname пользователя
      description: Изменение никнейма пользователя
      tags:
        - User Profile
      security:
        - cookieAuth: ['profile-watch', 'profile-change']
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                New-Nickname:
                  type: string
                  example: jack33
              required:
                - New-Nickname
      responses:
        '200':
          description: Nickname успешно изменен
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Nickname updated successfully"
        '400':
          description: Неверный формат nickname
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid nickname format"
        '403':
          description: Недостаточно прав
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Insufficient permissions"

  /oapi/v1/accounts/password:
    put:
      summary: Сменить пароль пользователя
      description: Изменение пароля пользователя
      tags:
        - Authentication
      security:
        - cookieAuth: ['profile-watch', 'profile-change']
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                New-Password:
                  type: string
                  example: "0000"
              required:
                - New-Password
      responses:
        '200':
          description: Пароль успешно изменен
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Password updated successfully"
        '400':
          description: Слабый пароль
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Password is too weak"
        '403':
          description: Недостаточно прав
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Insufficient permissions"

  /oapi/v1/accounts/email:
    put:
      summary: Сменить email пользователя
      description: |
        Изменение email пользователя. После смены почты аккаунт блокируется и на новую почту приходит письмо-подтверждение.
        После ввода токена из письма аккаунт разблокируется.
      tags:
        - User Profile
      security:
        - cookieAuth: ['profile-watch', 'profile-change']
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                New-Email:
                  type: string
                  format: email
                  example: artyomnazin@yandex.ru
              required:
                - New-Email
      responses:
        '200':
          description: Email успешно изменен, отправлено письмо подтверждения
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Email changed. Confirmation email sent."
        '400':
          description: Неверный формат email или email уже используется
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        '403':
          description: Недостаточно прав
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /oapi/v1/accounts/role:
    get:
      summary: Получить группу пользователя
      description: Получение роли (группы) текущего пользователя
      tags:
        - User Profile
      security:
        - cookieAuth: ['profile-watch']
      responses:
        '200':
          description: Успешное получение роли
          content:
            application/json:
              schema:
                type: object
                properties:
                  role:
                    type: string
                    example: admin
                  permissions:
                    type: array
                    items:
                      type: string
        '401':
          description: Пользователь не авторизован
        '403':
          description: Недостаточно прав

  /oapi/v1/search/query:
    post:
      summary: Глобальный поиск
      description: Глобальный поиск по коллекциям, книгам и пользователям
      tags:
        - Search
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                Query:
                  type: string
                  example: cool
                  description: Поисковый запрос
                Types:
                  type: string
                  example: collection,user,book
                  description: Типы объектов для поиска (необязательно)
                Limit:
                  type: integer
                  example: 1
                  description: Ограничение количества результатов (необязательно)
              required:
                - Query
      responses:
        '200':
          description: Успешный поиск
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object
                      properties:
                        type:
                          type: string
                          enum: [collection, user, book]
                        id:
                          type: integer
                        name:
                          type: string
                        score:
                          type: number
                          format: float
                  total:
                    type: integer
                    example: 5

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: Authorization
      description: JWT токен в cookie Authorization
    refreshCookieAuth:
      type: apiKey
      in: cookie
      name: Refresh
      description: Refresh токен в cookie Refresh